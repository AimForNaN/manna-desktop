<link rel="import" href="./bower_components/iron-a11y-keys-behavior/iron-a11y-keys-behavior.html">
<link rel="import" href="./bower_components/iron-pages/iron-pages.html">
<link rel="import" href="./bower_components/paper-header-panel/paper-header-panel.html">
<link rel="import" href="./bower_components/paper-toolbar/paper-toolbar.html">

<link rel="import" href="common.html">

<dom-module id="manna-desktop-module-view">
	<template>
		<style include="manna-desktop-style">
			:host {
				min-width: 25vw;

				@apply(--layout-vertical);
			}

			:host #toolbar {
				cursor: pointer;
			}

			:host #toolbarPages {
				@apply(--layout-fit);
			}

			:host #toolbarPages > * {
				font-family: "Liberation Serif";
				padding: 0 1em;

				@apply(--layout-center);
				@apply(--layout-fit);
				@apply(--layout-horizontal);
			}

			:host #toolbarPages .key {
				border: 0;
				outline: 0;
				text-indent: 1em;
				width: 100%;

				@apply(--layout-fit);
			}

			:host .content {
				padding: 1rem 2em;
			}

			:host .content .line.block {
				margin-bottom: 1em;
			}

			:host .content .line .verse-number {
				color: #999;
				font-size: 9pt;
			}

			:host .module {
				background-color: #FFF;
				border-bottom: 1px solid #E7E7E7;
				min-height: 20px;
				min-width: 25vw;
				overflow: hidden;
				padding: 1em;

				@apply(--layout-vertical);
			}

			:host .paper-header {
				--paper-toolbar: {
					border-bottom: 1px solid #F5F5F5;
					position: sticky;
				};
			}
		</style>
		<iron-ajax
			handle-as="json"
			id="ajaxModule"
			last-response="{{modules}}"
			params="[[_computeParams(module, key)]]"
			url="http://localhost:7777/v1/modules"
		></iron-ajax>
		<paper-header-panel mode="waterfall">
			<paper-toolbar id="toolbar">
				<iron-pages attr-for-selected="name" id="toolbarPages" selected="main">
					<div name="main" on-tap="showKeyInput">
						<template is="dom-if" if="[[module]]">
							[[module.Name]]
						</template>
					</div>
					<div name="key">
						<input class="key" id="keyInput" is="iron-input" value="[[key]]">
					</div>
				</iron-pages>
			</paper-toolbar>
			<template is="dom-if" if="[[module]]">
				<template as="text" is="dom-repeat" items="[[_computeRenderedText(module.Text)]]">
					<div class="module">
						<paper-toolbar class="paper-header">
							<div class="title">[[text.key]]</div>
						</paper-toolbar>
						<div class="content">
							<template as="line" is="dom-repeat" items="[[text.items]]">
								<span class$="line [[_computeLineStyle(lineByLine)]]">
									<template is="dom-if" if="[[verseNumbers]]">
										<template is="dom-if" if="[[isVerse(line)]]">
											<sup class="verse-number">[[line.Verse]]</sup>
										</template>
									</template>
									[[_computeText(line.Text)]]
								</span>
							</template>
						</div>
					</div>
				</template>
			</template>
		</paper-header-panel>
	</template>
	<script>
		Polymer({
			is: 'manna-desktop-module-view'
		,	properties: {
				'key': {
					type: String
				}
			,	'lineByLine': {
					type: Boolean
				,	value: false
				}
			,	'module': {
					type: Object
				}
			,	'verseNumbers': {
					type: Boolean
					,	value: true
				}
			}
		,	behaviors: [
				Polymer.IronA11yKeysBehavior
			]
		,	keyBindings: {
				'esc': 'showMainToolbarPage'
			,	'enter': '_onEnterKey'
			}
		,	observers: [
				'_computeModule(modules)'
			]
		,	_computeLineStyle: function (line) {
				return line ? 'block' : '';
			}
		,	_computeModule: function (mods) {
				if (mods && mods.length) {
					var name = this._computeName()
					,	len = mods.length
					;
					for (var i = 0; i < len; i++) {
						var mod = mods[i];
						if (name == mod['Name']) {
							this.module = mod;
							return;
						}
					}
				}
			}
		,	_computeName: function () {
				return this.module && this.module['Name'];
			}
		,	_computeParams: function () {
				return {
					'Get': [
						this._computeName()
					]
				,	'Key': this.key
				};
			}
		,	_computeRenderedText: function (text) {
				var type = {}
				,	len  = text.length
				;
				// Prepare text for sorting!
				for (let i = 0; i < len; ++i) {
					var t = text[i];
					switch (t['class']) {
						case 'verse': {
							let key = t['Book'] + ' ' + t['Chapter'];
							if (!type[key]) {
								type[key] = []
							}
							type[key].push(t);
							break;
						}
					}
				}

				// Sort everything into a parent-child tree!
				var ret  = []
				,	keys = Object.keys(type)
				;
				len = keys.length;
				for (let i = 0; i < keys.length; i++) {
					let key = keys[i]
					,	c   = type[key]
					;
					ret.push({
						key: key
					,	items: c
					});
				}
				return ret;
			}
		,	_computeText: function (text) {
				var t = String(text);
				return t.replace(/<[^>]+>/g, '');
			}
		,	_onEnterKey: function () {
				this.key = this.$.keyInput.value;
				this.$.ajaxModule.generateRequest();
			}
		,	isVerse: function (v) {
				return v && v['class'] == 'verse';
			}
		,	showKeyInput: function () {
				this.$.toolbarPages.select('key');
				this.$.keyInput.focus();
				this.$.keyInput.select();
			}
		,	showMainToolbarPage: function () {
				this.$.keyInput.blur();
				this.$.toolbarPages.select('main');
			}
		});
	</script>
</dom-module>
